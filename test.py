import streamlit as st
import pandas as pd
from io import StringIO

# ---------------------------
# ê¸°ë³¸ ì„¤ì •
# ---------------------------
st.set_page_config(
    page_title="í”¼ë¶€ ê³ ë¯¼ë³„ ì„±ë¶„ ì¶”ì²œ",
    page_icon="ğŸŒ¿",
    layout="wide",
)

st.title("ğŸŒ¿ í”¼ë¶€ ê³ ë¯¼ë³„ í™”ì¥í’ˆ ì„±ë¶„ ì¶”ì²œê¸°")
st.caption("í”¼ë¶€ ìƒíƒœì™€ ëª©í‘œì— ë§ëŠ” ì„±ë¶„ì„ ë˜‘ë˜‘í•˜ê²Œ ê³ ë¥´ì„¸ìš”. (ì˜ë£Œ ì •ë³´ê°€ ì•„ë‹Œ ì¼ë°˜ ê°€ì´ë“œì…ë‹ˆë‹¤)")

# ---------------------------
# ë°ì´í„°ë² ì´ìŠ¤ (ê°„ë‹¨ ë²„ì „)
# ---------------------------
ingredients_db = {
    # ë¯¸ë°±/ìƒ‰ì†Œ
    "ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ": {
        "concerns": ["ë¯¸ë°±/ì¡í‹°", "í”¼ì§€/ìœ ë¶„", "ì§„ì •/ë¶‰ì€ê¸°", "ëª¨ê³µ/ê²°"],
        "desc": "ë¹„íƒ€ë¯¼ B3. ìƒ‰ì†Œ ê· ì¼í™”, í”¼ì§€ ì¡°ì ˆ, ì¥ë²½ ê°•í™”, í™ë°˜ ê°œì„ ì— ë„ì›€.",
        "pairs": ["ì•„ì ¤ë¼ìµì‚°", "ì•ŒíŒŒì•Œë¶€í‹´", "ì§•í¬ PCA", "ì„¸ë¼ë§ˆì´ë“œ"],
        "avoid_with": [],
        "usage": "ë§¤ì¼ AM/PM ì‚¬ìš© ê°€ëŠ¥. 2~5%ë¡œ ì‹œì‘.",
        "strength": "2â€“10%",
        "pregnancy_safe": True,
        "skin": ["ê±´ì„±", "ì§€ì„±", "ë³µí•©ì„±", "ë¯¼ê°ì„±", "ì¤‘ì„±"],
        "kproducts": [
            "ë·°í‹°ì˜¤ë¸Œì¡°ì„  ê¸€ë¡œìš° ì„¸ëŸ¼: í”„ë¡œí´ë¦¬ìŠ¤+ë‚˜ì´ì•„ì‹ ", 
            "ë¼ìš´ë“œë© ìì‘ë‚˜ë¬´ ìˆ˜ë¶„ í† ë„ˆ (ë‚˜ì´ì•„ì‹  í•¨ìœ )",
            "ë‹¥í„°ì§€ ë ˆë“œ ë¸”ë ˆë¯¸ì‰¬ í´ë¦¬ì–´ ìˆ˜ë”© í¬ë¦¼"
        ],
    },
    "ë¹„íƒ€ë¯¼C(ì•„ìŠ¤ì½”ë¹…ì‚°)": {
        "concerns": ["ë¯¸ë°±/ì¡í‹°", "íƒ„ë ¥/ì£¼ë¦„", "í•­ì‚°í™”"],
        "desc": "ê°•ë ¥í•œ í•­ì‚°í™” ë° ìƒ‰ì†Œ ì™„í™”. ì½œë¼ê² í•©ì„± ë³´ì¡°.",
        "pairs": ["ë¹„íƒ€ë¯¼E", "í˜ë£°ì‚°", "ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ(ì™„ì¶©/ì €ìê·¹í˜•)", "ì„ í¬ë¦¼"],
        "avoid_with": ["ê°•ì‚°ì„± ê°ì§ˆì œê±°ì œ(ê°™ì€ ë£¨í‹´ ê³ ë†ë„)", "ë²¤ì¡°ì¼í¼ì˜¥ì‚¬ì´ë“œ(ë™ì‹œ ì‚¬ìš© ë¹„ê¶Œì¥)"],
        "usage": "ì•„ì¹¨ ë‹¨ë… ë˜ëŠ” í•­ì‚°í™” ì„¸ëŸ¼ ë‹¨ê³„. ì €ë†ë„(5â€“10%)â†’ì ì‘ í›„ 15%. ì‚°í™” ì£¼ì˜.",
        "strength": "5â€“20% (L-AA ê¸°ì¤€)",
        "pregnancy_safe": True,
        "skin": ["ê±´ì„±", "ì§€ì„±", "ë³µí•©ì„±", "ì¤‘ì„±"],
        "kproducts": [
            "ë¸Œë§ê·¸ë¦° ë¹„íƒ€C í†¤ì—… ì„¸ëŸ¼",
            "ì½”ìŠ¤ì•Œì—‘ìŠ¤ ë” ë¹„íƒ€ë¯¼C 23 ì„¸ëŸ¼"
        ],
    },
    "ì•ŒíŒŒì•Œë¶€í‹´": {
        "concerns": ["ë¯¸ë°±/ì¡í‹°"],
        "desc": "í‹°ë¡œì‹œë‚˜ì•„ì œ ì–µì œ. ì¡í‹°/ë©œë¼ë‹Œ ì™„í™”.",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "ì•„ì ¤ë¼ìµì‚°"],
        "avoid_with": [],
        "usage": "AM/PM ì‚¬ìš© ê°€ëŠ¥. 1â€“2%.",
        "strength": "1â€“2%",
        "pregnancy_safe": True,
        "skin": ["ê±´ì„±", "ì§€ì„±", "ë³µí•©ì„±", "ë¯¼ê°ì„±", "ì¤‘ì„±"],
        "kproducts": ["ë”ë©ë°”ì´ë¸”ë‘ë‘ ì•Œë¶€í‹´ ì„¸ëŸ¼"],
    },
    # ì—¬ë“œë¦„/í”¼ì§€
    "ì‚´ë¦¬ì‹¤ì‚°(BHA)": {
        "concerns": ["ì—¬ë“œë¦„", "ë¸”ë™í—¤ë“œ", "ëª¨ê³µ/ê²°", "í”¼ì§€/ìœ ë¶„"],
        "desc": "ì§€ìš©ì„± ê°ì§ˆ ìš©í•´. ë¸”ë™í—¤ë“œ/ê°ì§ˆ/í”¼ì§€ ì •ë¦¬.",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "ì§•í¬ PCA"],
        "avoid_with": ["ë ˆí‹°ë…¸ì´ë“œ(ë™ì‹œ ê³ ë†ë„)", "ë²¤ì¡°ì¼í¼ì˜¥ì‚¬ì´ë“œ(ìê·¹â†‘)"],
        "usage": "ê²©ì¼ ì €ë¹ˆë„ë¡œ ì‹œì‘. í† ë„ˆ/ì„¸ëŸ¼/ìŠ¤íŒŸ. ë°˜ë“œì‹œ ë³´ìŠµ & ìì™¸ì„  ì°¨ë‹¨.",
        "strength": "0.5â€“2%",
        "pregnancy_safe": True,
        "skin": ["ì§€ì„±", "ë³µí•©ì„±", "ì¤‘ì„±"],
        "kproducts": [
            "íŒŒì´ì˜¬ë¡œì§€ BHA í† ë„ˆ",
            "ë°”ì´ì˜¤ë”ë§ˆ ì„¸ë¹„ì—„ ì„¸ëŸ¼ (êµ­ë‚´ ìœ í†µ ë²„ì „ ìƒì´ ê°€ëŠ¥)"
        ],
    },
    "ê¸€ë¦¬ì½œë¦­ì‚°(AHA)": {
        "concerns": ["ëª¨ê³µ/ê²°", "ë¯¸ë°±/ì¡í‹°", "íƒ„ë ¥/ì£¼ë¦„"],
        "desc": "ìˆ˜ìš©ì„± ê°ì§ˆ ì œê±°. í‘œí”¼ í„´ì˜¤ë²„, í”¼ë¶€ê²° ê°œì„ .",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "PHA", "ë³´ìŠµì œ"],
        "avoid_with": ["ë¹„íƒ€ë¯¼C(ê°™ì€ ë£¨í‹´ ê³ ë†ë„)", "ë ˆí‹°ë…¸ì´ë“œ(ë™ì‹œ ê³ ë†ë„)"],
        "usage": "ì£¼ 2â€“3íšŒ ë°¤ì—. ì €ë†ë„(5â€“8%)ì—ì„œ ì‹œì‘.",
        "strength": "5â€“10%(í™ˆì¼€ì–´)",
        "pregnancy_safe": True,
        "skin": ["ê±´ì„±", "ë³µí•©ì„±", "ì¤‘ì„±"],
        "kproducts": ["í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ AHA í† ë„ˆ"],
    },
    "ì•„ì ¤ë¼ìµì‚°": {
        "concerns": ["ì—¬ë“œë¦„", "ë¯¸ë°±/ì¡í‹°", "ì§„ì •/ë¶‰ì€ê¸°"],
        "desc": "í•­ì—¼/ì—¬ë“œë¦„/ìƒ‰ì†Œ/í™ì¡° ë‹¤ëª©ì .",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "BHA", "ì„¸ë¼ë§ˆì´ë“œ"],
        "avoid_with": ["ê°•ì‚°ì„± ì œí’ˆ ë‹¤ì¤‘ ë ˆì´ì–´ë§"],
        "usage": "í•˜ë£¨ 1íšŒ ë°¤ë¶€í„°. 10% ì „í›„ í™ˆì¼€ì–´.",
        "strength": "5â€“15%",
        "pregnancy_safe": True,
        "skin": ["ê±´ì„±", "ì§€ì„±", "ë³µí•©ì„±", "ë¯¼ê°ì„±", "ì¤‘ì„±"],
        "kproducts": ["ë”ë©ë°”ì´ë¸”ë‘ë‘ ì•„ì ¤ë¼ìµì‚° í¬ë¦¼"],
    },
    "ë²¤ì¡°ì¼í¼ì˜¥ì‚¬ì´ë“œ": {
        "concerns": ["ì—¬ë“œë¦„"],
        "desc": "P. acnes ì‚´ê· . ì—¼ì¦ì„± ìŠ¤íŒŸì— íš¨ê³¼ì .",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "ì§„ì •/ë³´ìŠµ"],
        "avoid_with": ["ë ˆí‹°ë…¸ì´ë“œ(ë™ì‹œ)", "ë¹„íƒ€ë¯¼C(L-AA) ë™ì‹œ"],
        "usage": "ìŠ¤íŒŸ ë˜ëŠ” ì €ë†ë„ ì „ë©´. ì²œì²œíˆ ì ì‘.",
        "strength": "2.5â€“5%",
        "pregnancy_safe": True,
        "skin": ["ì§€ì„±", "ë³µí•©ì„±"],
        "kproducts": ["ì¼ë¶€ ì˜ì•½ì™¸í’ˆ/ì•½êµ­ ì œí’ˆ ì°¸ê³ "],
    },
    # ì¥ë²½/ë³´ìŠµ/ì§„ì •
    "ì„¸ë¼ë§ˆì´ë“œ": {
        "concerns": ["ê±´ì¡°/ì¥ë²½", "ë¯¼ê°/í™ì¡°"],
        "desc": "í”¼ë¶€ ì¥ë²½ ì§€ì§ˆ ë³´ì¶©. ìê·¹ ì™„í™” ë° ìˆ˜ë¶„ ìœ ì§€.",
        "pairs": ["ì½œë ˆìŠ¤í…Œë¡¤", "ì§€ë°©ì‚°", "ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ"],
        "avoid_with": [],
        "usage": "AM/PM í¬ë¦¼ ë‹¨ê³„. ê°ì§ˆì œê±°/ë ˆí‹°ë†€ê³¼ ë³‘í–‰ ì‹œ ìê·¹ ì™„í™”.",
        "strength": "ì„±ë¶„ ë°°í•©í˜•",
        "pregnancy_safe": True,
        "skin": ["ê±´ì„±", "ì§€ì„±", "ë³µí•©ì„±", "ë¯¼ê°ì„±", "ì¤‘ì„±"],
        "kproducts": ["ì¼ë¦¬ìœ¤ ì„¸ë¼ë§ˆì´ë“œ ì•„í†  í¬ë¦¼", "ë¼ë¡œìŠˆí¬ì œ ì‹œì¹´í”Œë¼ìŠ¤íŠ¸ B5"],
    },
    "íˆì•Œë£¨ë¡ ì‚°": {
        "concerns": ["ê±´ì¡°/ì¥ë²½", "ìˆ˜ë¶„ë¶€ì¡±"],
        "desc": "ìˆ˜ë¶„ ê²°í•©. í† ë„ˆ/ì„¸ëŸ¼/í¬ë¦¼ ì–´ë””ì„œë‚˜ ë³´ìŠµ.",
        "pairs": ["ê¸€ë¦¬ì„¸ë¦°", "íŒí…Œë†€", "ì„¸ë¼ë§ˆì´ë“œ"],
        "avoid_with": ["ë§¤ìš° ê±´ì¡°í•œ ì‹¤ë‚´Â·ì•¼ì™¸ì—ì„œ ë‹¨ë… ì‚¬ìš©(ì¦ë°œ ìœ ì˜)"],
        "usage": "ì –ì€ í”¼ë¶€ì— ë ˆì´ì–´ë§, ì´í›„ í¬ë¦¼ìœ¼ë¡œ ë°€í.",
        "strength": "ì €Â·ì¤‘Â·ê³ ë¶„ì í˜¼í•© ì„ í˜¸",
        "pregnancy_safe": True,
        "skin": ["ëª¨ë“  í”¼ë¶€"],
        "kproducts": ["í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì„¸ëŸ¼", "ì•„ì´ì†Œì´ íˆì•„ë£¨ë¡œë‹‰ í† ë„ˆ"]
    },
    "íŒí…Œë†€": {
        "concerns": ["ë¯¼ê°/í™ì¡°", "ê±´ì¡°/ì¥ë²½"],
        "desc": "ë¹„íƒ€ë¯¼ B5. ì§„ì •/ë³´ìŠµ/ì¥ë²½ ê°•í™”.",
        "pairs": ["ì•Œë€í† ì¸", "ë§ˆë°ì¹´ì†Œì‚¬ì´ë“œ", "ì„¼í…”ë¼"],
        "avoid_with": [],
        "usage": "AM/PM ì–´ë””ì„œë‚˜.",
        "strength": "2â€“10%",
        "pregnancy_safe": True,
        "skin": ["ëª¨ë“  í”¼ë¶€"],
        "kproducts": ["ë¼ìš´ë“œë© ìì‘ë‚˜ë¬´ ë¡œì…˜", "ë‹¥í„°ìë¥´íŠ¸ ì‹œì¹´í˜ì–´ ì„¸ëŸ¼"],
    },
    # ì•ˆí‹°ì—ì´ì§•
    "ë ˆí‹°ë†€": {
        "concerns": ["íƒ„ë ¥/ì£¼ë¦„", "ëª¨ê³µ/ê²°", "ì—¬ë“œë¦„"],
        "desc": "ë¹„íƒ€ë¯¼A ìœ ë„ì²´. ì½œë¼ê²/í„´ì˜¤ë²„. ìê·¹ ì£¼ì˜.",
        "pairs": ["ì„¸ë¼ë§ˆì´ë“œ", "íŒí…Œë†€", "í©íƒ€ì´ë“œ"],
        "avoid_with": ["ë²¤ì¡°ì¼í¼ì˜¥ì‚¬ì´ë“œ", "ê³ ë†ë„ AHA/BHA ë™ì‹œ", "ì„ì‹ /ìˆ˜ìœ "],
        "usage": "ì£¼ 2íšŒ ë°¤ë¶€í„°, ì™„ì „ ê±´ì¡° í”¼ë¶€ ìœ„ì— ì†ŒëŸ‰. ì ì‘ í›„ ì¦ëŸ‰.",
        "strength": "0.1â€“0.3% (ì´ˆë³´) / 0.5â€“1% (ìˆ™ë ¨)",
        "pregnancy_safe": False,
        "skin": ["ê±´ì„±", "ë³µí•©ì„±", "ì¤‘ì„±"],
        "kproducts": ["ë”ë©ë°”ì´ë¸”ë‘ë‘ ë ˆí‹°ë†€ í¬ë¦¼", "ì½”ìŠ¤ì•Œì—‘ìŠ¤ ë ˆí‹°ë†€ 0.1"],
    },
    "ë ˆí‹°ë‚ ": {
        "concerns": ["íƒ„ë ¥/ì£¼ë¦„", "ëª¨ê³µ/ê²°"],
        "desc": "ë ˆí‹°ë†€ë³´ë‹¤ í•œ ë‹¨ê³„ í™œì„±ì— ê°€ê¹Œìš´ ë¹„íƒ€ë¯¼A. ë¹ ë¥¸ ì²´ê°, ìê·¹ë„ ì¡´ì¬.",
        "pairs": ["ì„¸ë¼ë§ˆì´ë“œ", "í©íƒ€ì´ë“œ"],
        "avoid_with": ["ë²¤ì¡°ì¼í¼ì˜¥ì‚¬ì´ë“œ", "ê°•ì‚°ì„± ê°ì§ˆì œê±°ì œ"],
        "usage": "ì£¼ 2íšŒ ë°¤. ì €ë†ë„ì—ì„œ ì‹œì‘.",
        "strength": "0.05â€“0.1%",
        "pregnancy_safe": False,
        "skin": ["ë³µí•©ì„±", "ì¤‘ì„±"],
        "kproducts": ["ì•„ì´ì†Œì´ ë ˆí‹°ë‚  í¬ë¦¼ (ì„±ë¶„ ìœ ì‚¬ ì œí’ˆ ì°¸ê³ )"],
    },
    "í©íƒ€ì´ë“œ": {
        "concerns": ["íƒ„ë ¥/ì£¼ë¦„", "ì¥ë²½/ë³´ìŠµ"],
        "desc": "ì‹ í˜¸/êµ¬ì¡° í©íƒ€ì´ë“œ. íƒ„ë ¥ ë° ë³´ìŠµ ë³´ì¡°.",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "íˆì•Œë£¨ë¡ ì‚°"],
        "avoid_with": [],
        "usage": "AM/PM ì–´ë””ì„œë‚˜. ìê·¹ ì ìŒ.",
        "strength": "ë°°í•©í˜•",
        "pregnancy_safe": True,
        "skin": ["ëª¨ë“  í”¼ë¶€"],
        "kproducts": ["ë¹„í”Œë ˆì¸ í©íƒ€ì´ë“œ ì•°í”Œ", "ë©”ë””í í©íƒ€ì´ë“œ í¬ë¦¼"],
    },
    # í”¼ì§€/ìœ ë¶„ & ëª¨ê³µ
    "ì§•í¬ PCA": {
        "concerns": ["í”¼ì§€/ìœ ë¶„", "ì—¬ë“œë¦„"],
        "desc": "í”¼ì§€ ì¡°ì ˆ ë° ì§„ì • ë³´ì¡°.",
        "pairs": ["ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ", "BHA"],
        "avoid_with": [],
        "usage": "AM/PM ê°€ë²¼ìš´ ì„¸ëŸ¼/í† ë„ˆ.",
        "strength": "0.3â€“1%",
        "pregnancy_safe": True,
        "skin": ["ì§€ì„±", "ë³µí•©ì„±", "ì¤‘ì„±"],
        "kproducts": ["ë”í˜ì´ìŠ¤ìƒµ ë”í…Œë¼í”¼ í† ë„ˆ (ì„±ë¶„ ìœ ì‚¬)"]
    },
    # ë¯¼ê°/í™ì¡°
    "ì„¼í…”ë¼ ì•„ì‹œì•„í‹°ì¹´(ì‹œì¹´)": {
        "concerns": ["ë¯¼ê°/í™ì¡°", "ì¥ë²½/ë³´ìŠµ"],
        "desc": "íŠ¸ë¦¬í„°íœ ì„±ë¶„ì´ ì§„ì •/ë³µêµ¬ ë³´ì¡°.",
        "pairs": ["íŒí…Œë†€", "ì•Œë€í† ì¸", "ì„¸ë¼ë§ˆì´ë“œ"],
        "avoid_with": [],
        "usage": "AM/PM ì–´ë””ì„œë‚˜.",
        "strength": "ë°°í•©í˜•",
        "pregnancy_safe": True,
        "skin": ["ëª¨ë“  í”¼ë¶€"],
        "kproducts": ["ë‹¥í„°ìë¥´íŠ¸ ì‹œì¹´í˜ì–´ í¬ë¦¼", "ì•„ë¹„ë¸Œ ì–´ì„±ì´ˆ í† ë„ˆ(ì§„ì • ê³„ì—´)"],
    },
}

concern_options = [
    "ì—¬ë“œë¦„", "ë¸”ë™í—¤ë“œ", "í”¼ì§€/ìœ ë¶„", "ëª¨ê³µ/ê²°", "ë¯¸ë°±/ì¡í‹°",
    "ê±´ì¡°/ì¥ë²½", "ìˆ˜ë¶„ë¶€ì¡±", "ë¯¼ê°/í™ì¡°", "íƒ„ë ¥/ì£¼ë¦„", "í•­ì‚°í™”"
]

skin_types = ["ê±´ì„±", "ì§€ì„±", "ë³µí•©ì„±", "ë¯¼ê°ì„±", "ì¤‘ì„±"]

# ---------------------------
# ì‚¬ì´ë“œë°” - ì‚¬ìš©ì ì…ë ¥
# ---------------------------
st.sidebar.header("ë‚˜ì˜ í”¼ë¶€ ì •ë³´")
selected_skin = st.sidebar.selectbox("í”¼ë¶€ íƒ€ì…", options=skin_types, index=2)
selected_concerns = st.sidebar.multiselect(
    "í•´ê²°í•˜ê³  ì‹¶ì€ í”¼ë¶€ ê³ ë¯¼ (ë³µìˆ˜ ì„ íƒ)", options=concern_options, default=["ëª¨ê³µ/ê²°"]
)
pregnancy_mode = st.sidebar.toggle("ì„ì‹ /ìˆ˜ìœ  ì¤‘ (ë ˆí‹°ë…¸ì´ë“œ ìë™ ì œì™¸)", value=False)
sensitive_mode = st.sidebar.toggle("ì˜ˆë¯¼í•¨/ë”°ê°€ì›€ì´ ì‰½ê²Œ ìƒê¹€", value=False)
level = st.sidebar.slider("ë£¨í‹´ ê°•ë„(ì ìš© ì„±ë¶„ ìˆ˜)", min_value=1, max_value=6, value=3)

st.sidebar.info("í•­ìƒ ìì™¸ì„  ì°¨ë‹¨ì œ(SPF 30+)ëŠ” ì•„ì¹¨ ë£¨í‹´ì˜ í•„ìˆ˜ ë‹¨ê³„ì…ë‹ˆë‹¤ â˜€ï¸")

# ---------------------------
# ì¶”ì²œ ë¡œì§
# ---------------------------
def score_ingredient(name, meta):
    score = 0
    # ê³ ë¯¼ ì¼ì¹˜ ê°€ì¤‘ì¹˜
    for c in selected_concerns:
        if c in meta["concerns"]:
            score += 3
    # í”¼ë¶€ íƒ€ì… ì í•©ì„±
    if selected_skin in meta["skin"] or "ëª¨ë“  í”¼ë¶€" in meta["skin"]:
        score += 2
    # ë¯¼ê° ëª¨ë“œë©´ ì‚°/ë ˆí‹°ë…¸ì´ë“œ ê°ì 
    if sensitive_mode and any(key in name for key in ["AHA", "BHA", "ë ˆí‹°" ]):
        score -= 2
    return score

# í•„í„°ë§
filtered = {}
for k, v in ingredients_db.items():
    if pregnancy_mode and v.get("pregnancy_safe") is False:
        continue
    # ë¯¼ê° ëª¨ë“œì—ì„œ ì•„ì£¼ ìê·¹ì ì¸ ì¡°í•©ì„ 1ì°¨ ì œì™¸
    if sensitive_mode and any(x in v.get("avoid_with", []) for x in ["ê°•ì‚°ì„± ê°ì§ˆì œê±°ì œ", "ê³ ë†ë„ AHA/BHA ë™ì‹œ"]):
        pass
    filtered[k] = v

# ì ìˆ˜ ë¶€ì—¬ ë° ì •ë ¬
scored = sorted([(k, v, score_ingredient(k, v)) for k, v in filtered.items()], key=lambda x: x[2], reverse=True)

# ìƒìœ„ Nê°œ ì„ íƒ (ë ˆë²¨)
recommended = [(k, v) for k, v, s in scored if s > 0][:level]

# ìƒí˜¸ì‘ìš© ì²´í¬
def find_conflicts(selected_items):
    names = [n for n, _ in selected_items]
    conflicts = []
    for n, meta in selected_items:
        for aw in meta.get("avoid_with", []):
            # ê°„ë‹¨ ë§¤ì¹­
            for other in names:
                if other == n:
                    continue
                if aw.split("(")[0].strip() in other:
                    conflicts.append((n, other, aw))
    # ëŒ€í‘œì ì¸ ì¶”ê°€ ê·œì¹™
    pairs = set([p for _, m in selected_items for p in m.get("pairs", [])])
    return conflicts

conflicts = find_conflicts(recommended)

# ---------------------------
# ì¶œë ¥ ì˜ì—­
# ---------------------------
col1, col2 = st.columns([2, 1])
with col1:
    st.subheader("ë§ì¶¤ ì„±ë¶„ ì¶”ì²œ ê²°ê³¼")
    if not selected_concerns:
        st.warning("ì™¼ìª½ì—ì„œ ê³ ë¯¼ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”.")
    elif not recommended:
        st.info("ì¡°ê±´ì— ë§ëŠ” ì„±ë¶„ì´ ì—†ì–´ìš”. í•„í„°ë¥¼ ì¡°ê¸ˆ ì™„í™”í•´ ë³´ì„¸ìš”.")
    else:
        for name, meta in recommended:
            with st.container(border=True):
                st.markdown(f"### âœ… {name}")
                st.write(meta["desc"])
                tags = ", ".join(meta["concerns"]) if meta.get("concerns") else ""
                st.caption(f"ì£¼ìš” íƒ€ê²Ÿ: {tags}")
                c1, c2, c3 = st.columns(3)
                c1.metric("ê¶Œì¥ ë†ë„/ë²”ìœ„", meta.get("strength", "ë°°í•©í˜•"))
                c2.metric("ì„ì‹ /ìˆ˜ìœ ", "ê°€ëŠ¥" if meta.get("pregnancy_safe", True) else "ë¹„ê¶Œì¥")
                c3.metric("ì í•© í”¼ë¶€", ", ".join(meta.get("skin", [])))
                st.markdown("**ì‚¬ìš© íŒ**: " + meta.get("usage", ""))
                if meta.get("pairs"):
                    st.markdown("**í•¨ê»˜ ì“°ë©´ ì¢‹ì€ ì„±ë¶„**: " + ", ".join(meta["pairs"]))
                if meta.get("avoid_with"):
                    st.markdown("**ì£¼ì˜/í”¼í•´ì•¼ í•  ì¡°í•©**: " + ", ".join(meta["avoid_with"]))
                if meta.get("kproducts"):
                    with st.expander("ğŸ‡°ğŸ‡· ì¶”ì²œ í•œêµ­ ì œí’ˆ â€˜ì˜ˆì‹œâ€™ (ì°¸ê³ ìš©)"):
                        for p in meta["kproducts"]:
                            st.write("â€¢ " + p)

    if conflicts:
        with st.expander("âš ï¸ ì„ íƒëœ ì„±ë¶„ ê°„ ì£¼ì˜ ì¡°í•©"):
            for a, b, why in conflicts:
                st.write(f"- {a} â†” {b}: {why}")

with col2:
    st.subheader("ë£¨í‹´ ë¹Œë”")
    st.caption("ì´ˆë³´ìëŠ” ë‹¨ê³„ ìˆ˜ë¥¼ ì¤„ì´ê³ , ìê·¹ ì„±ë¶„ì€ ê²©ì¼/ë°¤ì—!")
    am_steps = ["í´ë Œì €(ì €ìê·¹)", "í•­ì‚°í™”/ì§„ì •", "ë³´ìŠµì œ", "ì„ í¬ë¦¼(SPF 30+)" ]
    pm_steps = ["í´ë Œì €", "ì•¡í‹°ë¸Œ", "ë³´ìŠµì œ"]

    st.markdown("**ì•„ì¹¨(AM)**")
    am_list = []
    # í•­ì‚°í™” í›„ë³´: ë¹„íƒ€ë¯¼C, ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ, í©íƒ€ì´ë“œ, ì§„ì •ë¥˜
    for n, m in recommended:
        if any(c in m["concerns"] for c in ["í•­ì‚°í™”", "ì§„ì •/ë¶‰ì€ê¸°", "ì¥ë²½/ë³´ìŠµ", "ë¯¸ë°±/ì¡í‹°"]) and n not in ["ë ˆí‹°ë†€", "ë ˆí‹°ë‚ ", "ê¸€ë¦¬ì½œë¦­ì‚°(AHA)", "ì‚´ë¦¬ì‹¤ì‚°(BHA)"]:
            am_list.append(n)
    st.write(" â†’ ".join(am_steps))
    st.write("AM ì•¡í‹°ë¸Œ ì œì•ˆ: " + (", ".join(am_list[:2]) if am_list else "ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ, í©íƒ€ì´ë“œ ë“±"))

    st.markdown("**ì €ë…(PM)**")
    pm_list = []
    for n, m in recommended:
        if n in ["ë ˆí‹°ë†€", "ë ˆí‹°ë‚ ", "ê¸€ë¦¬ì½œë¦­ì‚°(AHA)", "ì‚´ë¦¬ì‹¤ì‚°(BHA)", "ì•„ì ¤ë¼ìµì‚°"]:
            pm_list.append(n)
    st.write(" â†’ ".join(pm_steps))
    st.write("PM ì•¡í‹°ë¸Œ ì œì•ˆ: " + (", ".join(pm_list[:2]) if pm_list else "ì§„ì •/ë³´ìŠµ ìœ„ì£¼"))

    st.divider()
    st.subheader("ë‚´ë³´ë‚´ê¸°")
    # í…Œì´ë¸” ìƒì„±
    if recommended:
        df = pd.DataFrame([
            {
                "ì„±ë¶„": n,
                "íƒ€ê²Ÿ": ", ".join(m.get("concerns", [])),
                "ê¶Œì¥ ë²”ìœ„": m.get("strength", ""),
                "ì„ì‹ /ìˆ˜ìœ ": "ê°€ëŠ¥" if m.get("pregnancy_safe", True) else "ë¹„ê¶Œì¥",
                "ì‚¬ìš© íŒ": m.get("usage", ""),
            }
            for n, m in recommended
        ])
        st.dataframe(df, hide_index=True, use_container_width=True)
        csv = df.to_csv(index=False).encode("utf-8-sig")
        st.download_button("CSVë¡œ ì €ì¥", data=csv, file_name="ingredient_recommendations.csv", mime="text/csv")
    else:
        st.caption("ì¶”ì²œì´ ìƒì„±ë˜ë©´ í‘œì™€ í•¨ê»˜ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤")

# ---------------------------
# í‘¸í„°/ì•ˆë‚´
# ---------------------------
st.divider()
st.markdown(
    """
**ì£¼ì˜**  
- ë³¸ ì•±ì€ ì¼ë°˜ì ì¸ ì½”ìŠ¤ë©”í‹± ê°€ì´ë“œì´ë©°, ì§ˆí™˜/ì•½ë¬¼ ì¹˜ë£ŒëŠ” ì „ë¬¸ê°€ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤.  
- ë¯¼ê° í”¼ë¶€/ì„ì‹ Â·ìˆ˜ìœ  ì¤‘ì—ëŠ” ì‹ ì¤‘í•˜ê²Œ í…ŒìŠ¤íŠ¸í•˜ê³ , ìê·¹ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”.  
- ì œí’ˆ ì„±ë¶„/ë°°í•©ì€ ë¸Œëœë“œ ë¦¬ë‰´ì–¼ë¡œ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"""
)
